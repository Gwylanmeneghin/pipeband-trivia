<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pipeband.fun - Your modern pipe band trivia</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Nunito', sans-serif; background: #ffffff; color: #1a2744; min-height: 100vh; }
        #root { min-height: 100vh; }
        @keyframes sound { 0%, 100% { height: 8px; } 50% { height: 24px; } }
    </style>
</head>
<body>
<div id="root"></div>
<script>
// ============================================
// CLOUDINARY CONFIGURATION
// ============================================
const CLOUDINARY_CLOUD_NAME = 'ddr45t7qk';
const CLOUDINARY_UPLOAD_PRESET = 'pipeband_unsigned';

// Audio data avec URLs Cloudinary directes
const audioData = [
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204721/2012_-_AaronMcLean_sujhzl.mp3", band: "Aaron McLean", year: "2012" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204720/2012_-_AndrewLawson_irxmjv.mp3", band: "Andrew Lawson", year: "2012" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204721/2012_-_BarryWilson_o9n1bl.mp3", band: "Barry Wilson", year: "2012" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204721/2012_-_BlairBrown_upkf1n.mp3", band: "Blair Brown", year: "2012" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204721/2012_-_CameronWard_qwmolk.mp3", band: "Cameron Ward", year: "2012" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204721/2012_-_ChrisMcNicholl_iy3n00.mp3", band: "Chris McNicholl", year: "2012" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204723/2012_-_CraigBrown_e4vexp.mp3", band: "Craig Brown", year: "2012" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204723/2012_-_EricWard_eo2ccg.mp3", band: "Eric Ward", year: "2012" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204724/2012_-_GavinNoade_kwngpj.mp3", band: "Gavin Noade", year: "2012" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204724/2012_-_MichaelMcKenna_m0gnvt.mp3", band: "Michael McKenna", year: "2012" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204724/2012_-_StephenCreighton_r7knn3.mp3", band: "Stephen Creighton", year: "2012" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204725/2014_-_Blair_Brown_uueug7.mp3", band: "Blair Brown", year: "2014" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204727/2014_-_Chris_McNicholl_n0cvwp.mp3", band: "Chris McNicholl", year: "2014" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204727/2014_-_Craig_Brown_a6vx5f.mp3", band: "Craig Brown", year: "2014" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204727/2014_-_Eric_Ward_xh6vcb.mp3", band: "Eric Ward", year: "2014" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204727/2014_-_Grant_Cassidy_wbtofa.mp3", band: "Grant Cassidy", year: "2014" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204730/2014_-_Grant_Maxwell_nnkvgx.mp3", band: "Grant Maxwell", year: "2014" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204728/2014_-_Jake_Jorgensen_krhty4.mp3", band: "Jake Jorgensen", year: "2014" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204729/2014_-_Jason_Hoy_lpe0uy.mp3", band: "Jason Hoy", year: "2014" },
    { file: "https://res.cloudinary.com/ddr45t7qk/video/upload/v1769204729/2014_-_Jonathon_Hoy_ohov9w.mp3", band: "Jonathon Hoy", year: "2014" }
];

const allBands = [...new Set(audioData.map(d => d.band))];
const allYears = [...new Set(audioData.map(d => d.year))];

const congratsMessages = {
    low: ["Your trivia score is like an early E, time to study!", "Keep practicing!", "Every piper starts somewhere!"],
    medium: ["No false fingering here‚Äîjust pure piping knowledge!", "You're getting the hang of it!", "Solid performance!"],
    high: ["You've got more right than a perfectly tuned chanter‚Äîwell done!", "Outstanding! You really know your pipe bands!", "Impressive!"]
};

const getLeaderboard = () => { const s = localStorage.getItem('pipeband_leaderboard'); return s ? JSON.parse(s) : []; };
const saveToLeaderboard = (e) => { const l = getLeaderboard(); l.push(e); l.sort((a,b) => b.points - a.points); localStorage.setItem('pipeband_leaderboard', JSON.stringify(l.slice(0,100))); };

const uploadToCloudinary = async (dataUrl) => {
    const formData = new FormData();
    formData.append('file', dataUrl);
    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    formData.append('folder', 'pipeband_shares');
    
    try {
        const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        return data.secure_url;
    } catch (error) {
        console.error('Cloudinary upload error:', error);
        return null;
    }
};
</script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

const shuffleArray = (arr) => { const s = [...arr]; for(let i=s.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [s[i],s[j]]=[s[j],s[i]]; } return s; };
const getRandomOptions = (correct, all, count=3) => { const others = all.filter(o => o !== correct); return shuffleArray([correct, ...shuffleArray(others).slice(0,count)]); };
const generateQuiz = (n=10) => shuffleArray(audioData).slice(0,Math.min(n,audioData.length)).map(item => ({...item, bandOptions: getRandomOptions(item.band, allBands), yearOptions: getRandomOptions(item.year, allYears)}));

const calculatePoints = (bc, yc, tl) => (bc ? 3 : 0) + (yc ? 1 : 0) + Math.floor((tl / 20) * 10);

const styles = {
    container: { minHeight:'100vh', display:'flex', flexDirection:'column' },
    logo: { fontSize:'1.5rem', fontWeight:800, color:'#1a2744', cursor:'pointer' },
    logoFun: { color:'#29b6f6', fontStyle:'italic' },
    btnPrimary: { background:'#29b6f6', color:'#fff', border:'none', padding:'12px 28px', borderRadius:'50px', fontSize:'0.95rem', fontWeight:700, cursor:'pointer', display:'inline-flex', alignItems:'center', gap:'8px', fontFamily:'Nunito,sans-serif' },
    btnSecondary: { background:'#fff', color:'#1a2744', border:'1px solid #e0e0e0', padding:'12px 28px', borderRadius:'50px', fontSize:'0.95rem', fontWeight:600, cursor:'pointer', fontFamily:'Nunito,sans-serif' },
    btnDisabled: { background:'#e0e0e0', color:'#999', cursor:'not-allowed' },
    footer: { padding:'20px', textAlign:'center', marginTop:'auto' },
    footerLink: { color:'#666', fontSize:'0.9rem', margin:'0 15px', cursor:'pointer' },
    input: { padding:'14px 20px', fontSize:'1rem', border:'2px solid #e0e0e0', borderRadius:'50px', outline:'none', width:'100%', maxWidth:'300px', fontFamily:'Nunito,sans-serif' },
};

const Logo = ({onClick, white}) => <div style={{...styles.logo, color:white?'#fff':'#1a2744'}} onClick={onClick}>pipeband<span style={{...styles.logoFun, color:white?'#fff':'#29b6f6'}}>.fun</span></div>;

const HomePage = ({onNavigate}) => (
    <div style={{...styles.container, justifyContent:'center', alignItems:'center', padding:'20px'}}>
        <div style={{position:'absolute',top:'30px'}}><Logo onClick={()=>onNavigate('home')}/></div>
        <div style={{textAlign:'center',maxWidth:'600px'}}>
            <h1 style={{fontSize:'clamp(2.5rem,8vw,4rem)',fontWeight:900,lineHeight:1.1,marginBottom:'24px',color:'#1a2744'}}>Your modern<br/>pipe band trivia.</h1>
            <p style={{color:'#666',fontSize:'1rem',lineHeight:1.6,marginBottom:'12px'}}>A fast-paced quiz that puts your pipe band knowledge to the test.</p>
            <p style={{color:'#666',fontSize:'1rem',marginBottom:'32px'}}>Think you've got what it takes? Let's find out!</p>
            <div style={{display:'flex',gap:'12px',justifyContent:'center',flexWrap:'wrap'}}>
                <button style={styles.btnPrimary} onClick={()=>onNavigate('login')}>Join Today</button>
            </div>
        </div>
        <div style={{...styles.footer,position:'absolute',bottom:'20px'}}>
            <span style={styles.footerLink} onClick={()=>onNavigate('about')}>About</span>
            <span style={styles.footerLink} onClick={()=>onNavigate('leaderboard')}>Leaderboard</span>
        </div>
    </div>
);

const LoginPage = ({onNavigate, onLogin}) => {
    const [username, setUsername] = useState('');
    const [error, setError] = useState('');
    const handleSubmit = (e) => { e.preventDefault(); if(username.trim().length<2){setError('Min 2 characters');return;} onLogin(username.trim()); onNavigate('ready'); };
    return (
        <div style={{...styles.container,justifyContent:'center',alignItems:'center',padding:'20px'}}>
            <div style={{marginBottom:'40px'}}><Logo onClick={()=>onNavigate('home')}/></div>
            <div style={{textAlign:'center',maxWidth:'400px',width:'100%'}}>
                <h1 style={{fontSize:'2rem',fontWeight:900,marginBottom:'12px',color:'#1a2744'}}>Enter your username</h1>
                <p style={{color:'#666',fontSize:'0.95rem',marginBottom:'32px'}}>Choose a username for the leaderboard</p>
                <form onSubmit={handleSubmit} style={{display:'flex',flexDirection:'column',alignItems:'center',gap:'16px'}}>
                    <input type="text" placeholder="Your username" value={username} onChange={e=>{setUsername(e.target.value);setError('');}} style={{...styles.input,borderColor:error?'#e74c3c':'#e0e0e0'}} autoFocus/>
                    {error && <p style={{color:'#e74c3c',fontSize:'0.85rem'}}>{error}</p>}
                    <button type="submit" style={styles.btnPrimary}>Continue</button>
                </form>
            </div>
        </div>
    );
};

const AboutPage = ({ onNavigate }) => {
            const faqItems = [
                {
                    question: "How does it work?",
                    answer: "You'll be given 10 questions per round. Each question features a 20-second audio clip from a well-known pipe band medley. Your job is to identify the correct tune before time runs out! The faster you answer, the higher your score."
                },              
                {
                    question: "What kind of tunes will I hear?",
                    answer: "The quiz includes tunes from legendary pipe band medleys between the 1980s and 2010s‚Äîthe golden era of competitive pipe band music. Expect everything from classic jigs and strathspeys to blistering reels and hornpipes."
                },
                {
                    question: "How is my score calculated?",
                    answer: "Correct answers earn you points. Faster responses get you bonus points. Score over 50% correct, and you'll get a special congratulations message!"
                },
                {
                    question: "Can I play more than once?",
                    answer: "Absolutely! Play as many times as you like and try to beat your best score."
                },
                {
                    question: "Can I challenge my friends?",
                    answer: "Yes! Share your score and see if your friends can match your pipe band medley expertise."
                },
                {
                    question: "What happens if I don't know the tune?",
                    answer: "No worries‚Äîjust take your best guess! Even if you don't score high, you'll still get to enjoy some of the best medley moments in pipe band history."
                },
                {
                    question: "How do I prove I'm the ultimate pipeband.fun Trivia champion?",
                    answer: "Score high, play often, and show off your results! If you consistently ace the quiz, you've got bragging rights as a true pipe band medley expert."
                }
            ];

            return (
                <div style={{
                    ...styles.container,
                    background: '#29b6f6',
                    color: '#fff',
                }}>
                    <div style={{
                        textAlign: 'center',
                        padding: '30px 20px',
                    }}>
                        <div style={{ ...styles.logo, color: '#fff' }} onClick={() => onNavigate('home')}>
                            pipeband<span style={{ ...styles.logoFun, color: '#fff' }}>.fun</span>
                        </div>
                    </div>
                    
                    <div style={{
                        maxWidth: '600px',
                        margin: '0 auto',
                        padding: '0 20px 40px',
                        textAlign: 'center',
                    }}>
                        <p style={{
                            fontSize: '1.1rem',
                            lineHeight: 1.7,
                            marginBottom: '20px',
                        }}>
                            <strong>Introducing pipeband.fun</strong> ‚Äî a fast-paced quiz that puts your medley knowledge to the test. Spanning iconic sets from the 1980s to the 2010s, this 10-question challenge gives you 20 seconds per clip to guess the tune.
                        </p>
                        
                        <div style={{
                            margin: '40px 0',
                            display: 'flex',
                            justifyContent: 'center',
                            alignItems: 'center',
                        }}>
                            <div style={{
                                width: '2px',
                                height: '100px',
                                background: 'rgba(255,255,255,0.3)',
                                marginRight: '30px',
                            }} />
                        </div>
                    </div>
                    
                    <div style={{
                        background: '#29b6f6',
                        padding: '40px 20px 60px',
                    }}>
                        <div style={{
                            maxWidth: '600px',
                            margin: '0 auto',
                        }}>
                            <h2 style={{
                                fontSize: '2.5rem',
                                fontWeight: 900,
                                marginBottom: '30px',
                            }}>FAQ</h2>
                            
                            {faqItems.map((item, index) => (
                                <div key={index} style={{ marginBottom: '24px', textAlign: 'left' }}>
                                    <h3 style={{
                                        fontSize: '1.1rem',
                                        fontWeight: 700,
                                        marginBottom: '8px',
                                    }}>{item.question}</h3>
                                    <p style={{
                                        fontSize: '0.95rem',
                                        lineHeight: 1.6,
                                        opacity: 0.95,
                                    }}>{item.answer}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    <div style={{
                        background: '#29b6f6',
                        padding: '40px 20px',
                        textAlign: 'center',
                    }}>
                        <div style={{
                            fontSize: '2rem',
                            fontWeight: 800,
                            fontStyle: 'italic',
                        }}>.fun</div>
                    </div>
                    
                    <div style={{
                        ...styles.footer,
                        background: '#29b6f6',
                        paddingBottom: '30px',
                    }}>
                        <span style={{ ...styles.footerLink, color: '#fff' }} onClick={() => onNavigate('about')}>About</span>
                        <span style={{ ...styles.footerLink, color: '#fff' }} onClick={() => onNavigate('leaderboard')}>Leaderboard</span>
                    </div>
                </div>
            );
        };

const ReadyPage = ({onNavigate, username}) => (
    <div style={{...styles.container,justifyContent:'center',alignItems:'center',padding:'20px',position:'relative'}}>
        <button onClick={()=>onNavigate('home')} style={{position:'absolute',top:'20px',right:'20px',background:'none',border:'none',fontSize:'1.5rem',cursor:'pointer',color:'#29b6f6'}}>√ó</button>
        <div style={{marginBottom:'40px'}}><Logo onClick={()=>onNavigate('home')}/></div>
        <div style={{textAlign:'center',maxWidth:'550px'}}>
            <h1 style={{fontSize:'clamp(2rem,6vw,2.8rem)',fontWeight:900,marginBottom:'24px',color:'#1a2744'}}>Ready, {username}?</h1>
            <p style={{color:'#666',fontSize:'0.95rem',lineHeight:1.7,marginBottom:'16px'}}>10 audio clips. Identify the <u>band</u> and <u>year</u> before time runs out!</p>
            <p style={{color:'#666',fontSize:'0.95rem',marginBottom:'40px'}}><strong>Scoring:</strong> 3 pts band + 1 pt year + up to 10 speed bonus</p>
            <button style={styles.btnPrimary} onClick={()=>onNavigate('quiz')}>Let's go!</button>
        </div>
    </div>
);

const QuizPage = ({onNavigate, username}) => {
    const [quiz] = useState(()=>generateQuiz(10));
    const [cur, setCur] = useState(0);
    const [selBand, setSelBand] = useState(null);
    const [selYear, setSelYear] = useState(null);
    const [timeLeft, setTimeLeft] = useState(20);
    const [totalPts, setTotalPts] = useState(0);
    const [totalTime, setTotalTime] = useState(0);
    const [bandScore, setBandScore] = useState(0);
    const [yearScore, setYearScore] = useState(0);
    const [playing, setPlaying] = useState(false);
    const timerRef = useRef(null);
    const audioRef = useRef(null);

    // Auto-start audio and timer when question changes
    useEffect(() => {
        setTimeLeft(20);
        setPlaying(false);
        
        const audio = audioRef.current;
        if (!audio) return;

        audio.currentTime = 0;
        audio.play()
            .then(() => {
                setPlaying(true);
                timerRef.current = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) {
                            handleContinue(true);
                            return 20;
                        }
                        return prev - 1;
                    });
                    setTotalTime(prev => prev + 1);
                }, 1000);
            })
            .catch(err => console.error('Audio play error:', err));
        
        return () => {
            clearInterval(timerRef.current);
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
            }
        };
    }, [cur]);

    const handleContinue = (timeout = false) => {
        clearInterval(timerRef.current);
        timerRef.current = null;
        
        const audio = audioRef.current;
        if (audio) {
            audio.pause();
            audio.currentTime = 0;
        }
        setPlaying(false);

        const q = quiz[cur];
        const bc = selBand === q.band;
        const yc = selYear === q.year;
        const pts = calculatePoints(bc, yc, timeout ? 0 : timeLeft);
        
        const newPts = totalPts + pts;
        const newBS = bandScore + (bc ? 1 : 0);
        const newYS = yearScore + (yc ? 1 : 0);
        
        setTotalPts(newPts);
        setBandScore(newBS);
        setYearScore(newYS);

        if (cur < quiz.length - 1) {
            setCur(c => c + 1);
            setSelBand(null);
            setSelYear(null);
        } else {
            saveToLeaderboard({
                username,
                points: newPts,
                bandScore: newBS,
                yearScore: newYS,
                totalTime,
                date: new Date().toISOString()
            });
            onNavigate('results', {
                points: newPts,
                bandScore: newBS,
                yearScore: newYS,
                totalTime,
                total: quiz.length,
                username
            });
        }
    };

    const q = quiz[cur];
    const canContinue = selBand && selYear;
    const progress = ((20 - timeLeft) / 20) * 100;

    return (
        <div style={{...styles.container, justifyContent:'center', alignItems:'center', padding:'20px', position:'relative'}}>
            <audio 
                ref={audioRef} 
                src={q.file}
                onEnded={() => setPlaying(false)}
                preload="auto"
            />
            
            <button onClick={() => onNavigate('home')} style={{position:'absolute', top:'20px', right:'20px', background:'none', border:'none', fontSize:'1.5rem', cursor:'pointer', color:'#29b6f6'}}>√ó</button>
            
            <div style={{marginBottom:'40px'}}><Logo onClick={() => onNavigate('home')}/></div>
            
            <div style={{textAlign:'center', maxWidth:'600px', width:'100%'}}>
                <div style={{marginBottom:'20px', display:'flex', justifyContent:'center', alignItems:'center', gap:'12px'}}>
                    {playing ? (
                        <div style={{display:'flex', gap:'4px', alignItems:'center', height:'32px'}}>
                            {[1,2,3,4,5].map(i => (
                                <div key={i} style={{
                                    width:'4px',
                                    backgroundColor:'#29b6f6',
                                    borderRadius:'2px',
                                    animation:`sound 0.5s ease-in-out infinite`,
                                    animationDelay:`${i * 0.1}s`,
                                    height:'16px'
                                }}/>
                            ))}
                        </div>
                    ) : (
                        <span style={{color:'#999'}}>üîá</span>
                    )}
                    <span style={{color:'#29b6f6', fontSize:'0.9rem', fontWeight:600}}>
                        {playing ? '‚ô™ Listen carefully...' : 'Audio ended'}
                    </span>
                </div>

                <div style={{display:'flex', alignItems:'center', justifyContent:'center', marginBottom:'30px', gap:'10px'}}>
                    <span style={{color: timeLeft <= 5 ? '#e74c3c' : '#29b6f6', fontWeight:700, fontSize:'1.3rem', minWidth:'30px'}}>{timeLeft}</span>
                    <div style={{width:'200px', height:'6px', background:'#e0e0e0', borderRadius:'3px', overflow:'hidden'}}>
                        <div style={{
                            width:`${100 - progress}%`,
                            height:'100%',
                            background: timeLeft <= 5 ? '#e74c3c' : '#29b6f6',
                            borderRadius:'3px',
                            transition:'width 1s linear'
                        }}/>
                    </div>
                </div>
                
                <h1 style={{fontSize:'clamp(1.8rem,5vw,2.5rem)', fontWeight:900, marginBottom:'30px', color:'#1a2744'}}>
                    Guess the band and year.
                </h1>
                
                <div style={{display:'flex', flexWrap:'wrap', gap:'10px', justifyContent:'center', marginBottom:'20px'}}>
                    {q.bandOptions.map(b => (
                        <button 
                            key={b} 
                            onClick={() => setSelBand(b)} 
                            style={{
                                padding:'10px 20px',
                                borderRadius:'50px',
                                border: selBand === b ? 'none' : '1px solid #e0e0e0',
                                background: selBand === b ? '#29b6f6' : '#fff',
                                color: selBand === b ? '#fff' : '#1a2744',
                                fontSize:'0.9rem',
                                fontWeight:600,
                                cursor:'pointer',
                                fontFamily:'Nunito,sans-serif',
                                transition:'all 0.2s ease'
                            }}
                        >
                            {b}
                        </button>
                    ))}
                </div>
                
                <div style={{display:'flex', flexWrap:'wrap', gap:'10px', justifyContent:'center', marginBottom:'50px'}}>
                    {q.yearOptions.map(y => (
                        <button 
                            key={y} 
                            onClick={() => setSelYear(y)} 
                            style={{
                                padding:'10px 20px',
                                borderRadius:'50px',
                                border: selYear === y ? 'none' : '1px solid #e0e0e0',
                                background: selYear === y ? '#29b6f6' : '#fff',
                                color: selYear === y ? '#fff' : '#1a2744',
                                fontSize:'0.9rem',
                                fontWeight:600,
                                cursor:'pointer',
                                fontFamily:'Nunito,sans-serif',
                                transition:'all 0.2s ease'
                            }}
                        >
                            {y}
                        </button>
                    ))}
                </div>
                
                <button 
                    style={{...styles.btnPrimary, ...(canContinue ? {} : styles.btnDisabled)}} 
                    onClick={() => handleContinue(false)} 
                    disabled={!canContinue}
                >
                    Continue
                </button>
                
                <div style={{marginTop:'30px', color:'#999', fontSize:'0.85rem'}}>
                    Question {cur + 1} of {quiz.length} ‚Ä¢ {totalPts} pts
                </div>
            </div>
        </div>
    );
};

const ResultsPage = ({onNavigate, data}) => {
    const canvasRef = useRef(null);
    const [imgUrl, setImgUrl] = useState(null);
    const [uploading, setUploading] = useState(false);
    
    const pts = data?.points || 0;
    const bs = data?.bandScore || 0;
    const ys = data?.yearScore || 0;
    const total = data?.total || 10;
    const tt = data?.totalTime || 0;
    const user = data?.username || 'Player';
    
    const mins = Math.floor(tt / 60);
    const secs = tt % 60;
    const timeStr = mins > 0 ? `${mins} min ${secs} sec` : `${secs} seconds`;
    
    const pct = ((bs + ys) / (total * 2)) * 100;
    const cat = pct >= 70 ? 'high' : pct >= 40 ? 'medium' : 'low';
    const msg = congratsMessages[cat][Math.floor(Math.random() * congratsMessages[cat].length)];

    useEffect(() => {
        const c = canvasRef.current;
        if (!c) return;
        
        const ctx = c.getContext('2d');
        const width = 1200;
        const height = 630;
        
        c.width = width;
        c.height = height;
        
        ctx.fillStyle = '#29b6f6';
        ctx.fillRect(0, 0, width, height);
        
        ctx.globalAlpha = 0.05;
        ctx.fillStyle = '#fff';
        for (let i = 0; i < 30; i++) {
            ctx.beginPath();
            ctx.arc(Math.random() * width, Math.random() * height, 20 + Math.random() * 40, 0, Math.PI * 2);
            ctx.fill();
        }
        ctx.globalAlpha = 1;
        
        ctx.font = 'bold 72px Nunito, Arial, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillStyle = '#1a2744';
        ctx.fillText('pipeband', width / 2 - 60, 120);
        ctx.fillStyle = '#fff';
        ctx.font = 'italic bold 72px Nunito, Arial, sans-serif';
        ctx.fillText('.fun', width / 2 + 170, 120);
        
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 52px Nunito, Arial, sans-serif';
        ctx.fillText(user, width / 2, 240);
        
        ctx.font = 'bold 100px Nunito, Arial, sans-serif';
        ctx.fillText(`${pts} points`, width / 2, 360);
        
        ctx.font = '32px Nunito, Arial, sans-serif';
        ctx.fillText(`"${msg}"`, width / 2, 450);
        
        ctx.font = '26px Nunito, Arial, sans-serif';
        ctx.fillText('Take the test over at ‚Äî www.pipeband.fun', width / 2, 570);
        
        setImgUrl(c.toDataURL('image/png'));
    }, [user, pts, msg]);

    const shareFB = async () => {
        if (!imgUrl) return;
        setUploading(true);
        
        const uploadedUrl = await uploadToCloudinary(imgUrl);
        
        if (uploadedUrl) {
            const fbShareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(uploadedUrl)}`;
            window.open(fbShareUrl, '_blank', 'width=600,height=400');
        } else {
            alert('Upload failed. Please download and share manually.');
        }
        setUploading(false);
    };

    const download = () => {
        if (imgUrl) {
            const a = document.createElement('a');
            a.download = `pipeband-${user}.png`;
            a.href = imgUrl;
            a.click();
        }
    };

    return (
        <div style={{...styles.container, justifyContent:'center', alignItems:'center', padding:'20px', position:'relative'}}>
            <canvas ref={canvasRef} style={{display:'none'}}/>
            
            <button onClick={() => onNavigate('home')} style={{position:'absolute', top:'20px', right:'20px', background:'none', border:'none', fontSize:'1.5rem', cursor:'pointer', color:'#29b6f6'}}>√ó</button>
            
            <div style={{marginBottom:'30px'}}><Logo onClick={() => onNavigate('home')}/></div>
            
            <div style={{textAlign:'center', maxWidth:'500px'}}>
                <h1 style={{fontSize:'2rem', fontWeight:900, marginBottom:'8px', color:'#1a2744'}}>
                    {pct >= 50 ? 'Congrats' : 'Nice try'}, {user}!
                </h1>
                
                <div style={{display:'flex', justifyContent:'center', gap:'15px', marginBottom:'16px', flexWrap:'wrap'}}>
                    <div style={{padding:'12px 24px', border:'2px solid #29b6f6', borderRadius:'50px', color:'#29b6f6', fontWeight:700}}>
                        ‚è± {timeStr}
                    </div>
                    <div style={{padding:'12px 24px', border:'2px solid #29b6f6', borderRadius:'50px', color:'#29b6f6', fontWeight:700}}>
                        ‚úì {pts} pts
                    </div>
                </div>

                <div style={{marginBottom:'16px', color:'#666', fontSize:'0.9rem'}}>
                    Bands: {bs}/{total} ‚Ä¢ Years: {ys}/{total}
                </div>
                
                <p style={{color:'#666', fontSize:'1rem', marginBottom:'20px', fontStyle:'italic'}}>
                    "{msg}"
                </p>
                
                {imgUrl && (
                    <img 
                        src={imgUrl} 
                        alt="Share" 
                        style={{
                            maxWidth:'100%',
                            borderRadius:'12px',
                            marginBottom:'20px',
                            boxShadow:'0 4px 20px rgba(0,0,0,0.1)'
                        }}
                    />
                )}
                
                <div style={{display:'flex', justifyContent:'center', gap:'12px', flexWrap:'wrap', marginBottom:'20px'}}>
                    <button 
                        style={{...styles.btnPrimary, background:'#1877f2', opacity: uploading ? 0.7 : 1}} 
                        onClick={shareFB}
                        disabled={uploading}
                    >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                        </svg>
                        {uploading ? 'Uploading...' : 'Share on Facebook'}
                    </button>
                    <button style={{...styles.btnPrimary, background:'#fff', color:'#29b6f6', border:'2px solid #29b6f6'}} onClick={download}>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Download
                    </button>
                </div>
                
                <div style={{display:'flex', justifyContent:'center', gap:'12px', flexWrap:'wrap'}}>
                    <button style={styles.btnSecondary} onClick={() => onNavigate('leaderboard')}>Leaderboard</button>
                    <button style={styles.btnSecondary} onClick={() => onNavigate('quiz')}>Play Again</button>
                </div>
            </div>
        </div>
    );
};

const LeaderboardPage = ({onNavigate}) => {
    const [lb, setLb] = useState([]);
    useEffect(() => setLb(getLeaderboard()), []);
    
    const icon = r => r === 1 ? 'üèÜ' : r === 2 ? 'ü•à' : r === 3 ? 'ü•â' : (
        <span style={{
            background:'#e0e0e0',
            borderRadius:'50%',
            width:'24px',
            height:'24px',
            display:'inline-flex',
            alignItems:'center',
            justifyContent:'center',
            fontSize:'0.75rem',
            fontWeight:700
        }}>{r}</span>
    );
    
    return (
        <div style={{...styles.container, padding:'30px 20px'}}>
            <div style={{textAlign:'center', marginBottom:'50px'}}>
                <Logo onClick={() => onNavigate('home')}/>
            </div>
            
            <div style={{maxWidth:'800px', margin:'0 auto'}}>
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'30px', flexWrap:'wrap', gap:'20px'}}>
                    <h1 style={{fontSize:'2.5rem', fontWeight:900, color:'#1a2744'}}>Leaderboard</h1>
                    <button style={styles.btnPrimary} onClick={() => onNavigate('login')}>Play Now</button>
                </div>
                
                {lb.length === 0 ? (
                    <div style={{textAlign:'center', padding:'60px 20px', color:'#666'}}>
                        <p style={{fontSize:'1.2rem'}}>No scores yet!</p>
                    </div>
                ) : (
                    lb.map((p, i) => (
                        <div key={i} style={{display:'flex', alignItems:'center', padding:'16px 0', borderBottom:'1px solid #f0f0f0'}}>
                            <div style={{width:'40px', fontSize:'1.5rem'}}>{icon(i + 1)}</div>
                            <div style={{flex:1, marginLeft:'10px'}}>
                                <div style={{fontWeight:700, color:'#1a2744', fontSize:'1.1rem'}}>{p.username}</div>
                                <div style={{color:'#999', fontSize:'0.85rem'}}>Bands: {p.bandScore}/10 ‚Ä¢ Years: {p.yearScore}/10</div>
                            </div>
                            <div style={{fontWeight:700, color: i === 0 ? '#f5a623' : '#1a2744', fontSize:'1.1rem'}}>
                                {p.points}pts
                            </div>
                        </div>
                    ))
                )}
            </div>
            
            <div style={styles.footer}>
                <span style={styles.footerLink} onClick={() => onNavigate('about')}>About</span>
                <span style={{...styles.footerLink, textDecoration:'underline'}} onClick={() => onNavigate('leaderboard')}>Leaderboard</span>
            </div>
        </div>
    );
};

const App = () => {
    const [page, setPage] = useState('home');
    const [data, setData] = useState(null);
    const [user, setUser] = useState(() => localStorage.getItem('pipeband_user') || '');
    
    const nav = (p, d = null) => {
        setPage(p);
        setData(d);
        window.scrollTo(0, 0);
    };
    
    const login = n => {
        setUser(n);
        localStorage.setItem('pipeband_user', n);
    };
    
    const render = () => {
        switch (page) {
            case 'home': return <HomePage onNavigate={nav}/>;
            case 'login': return <LoginPage onNavigate={nav} onLogin={login}/>;
            case 'about': return <AboutPage onNavigate={nav}/>;
            case 'ready': return <ReadyPage onNavigate={nav} username={user}/>;
            case 'quiz': return <QuizPage onNavigate={nav} username={user}/>;
            case 'results': return <ResultsPage onNavigate={nav} data={data}/>;
            case 'leaderboard': return <LeaderboardPage onNavigate={nav}/>;
            default: return <HomePage onNavigate={nav}/>;
        }
    };
    
    return render();
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
